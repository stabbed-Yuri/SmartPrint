<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/layout :: head('My Printers', ~{::custom-styles})}">
    <title>SmartPrint - My Printers</title>
    <th:block th:fragment="custom-styles">
        <style>
            .printer-table-container {
                overflow-x: auto;
                background-color: #fff;
                border-radius: 0.5rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                margin-bottom: 2rem;
            }
            .printer-table {
                width: 100%;
                border-collapse: collapse;
            }
            .printer-table th {
                background-color: #f1f5f9;
                color: #475569;
                font-weight: 600;
                text-align: left;
                padding: 1rem;
                font-size: 0.875rem;
            }
            .printer-table td {
                padding: 1rem;
                border-top: 1px solid #e2e8f0;
                font-size: 0.875rem;
                color: #0f172a;
            }
            .printer-table tr:hover {
                background-color: #f8fafc;
            }
            .status-indicator {
                display: inline-flex;
                align-items: center;
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                font-size: 0.75rem;
                font-weight: 500;
                text-transform: capitalize;
            }
            .status-indicator::before {
                content: "";
                display: inline-block;
                width: 0.5rem;
                height: 0.5rem;
                border-radius: 50%;
                margin-right: 0.25rem;
            }
            .status-online {
                background-color: #dcfce7;
                color: #166534;
            }
            .status-online::before {
                background-color: #16a34a;
            }
            .status-offline {
                background-color: #fee2e2;
                color: #b91c1c;
            }
            .status-offline::before {
                background-color: #dc2626;
            }
            .status-maintenance {
                background-color: #fef3c7;
                color: #92400e;
            }
            .status-maintenance::before {
                background-color: #f59e0b;
            }
            .status-error {
                background-color: #dbeafe;
                color: #1e40af;
            }
            .status-error::before {
                background-color: #3b82f6;
            }
            .actions {
                display: flex;
                gap: 0.5rem;
            }
            .btn-icon {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                background: none;
                border: none;
                color: #64748b;
                cursor: pointer;
                padding: 0.25rem;
                border-radius: 0.25rem;
                transition: all 0.2s;
            }
            .btn-icon:hover {
                background-color: #f1f5f9;
                color: #0f172a;
            }
            .section-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
            }
            .add-button {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .add-button::before {
                content: "+";
                font-size: 1.2rem;
                font-weight: 700;
            }
        </style>
    </th:block>
</head>

<body th:replace="~{fragments/layout :: main-layout('My Printers', ~{::content}, ~{::custom-styles}, ~{::custom-scripts})}">
    <th:block th:fragment="content">
        <!-- Main Content -->
        <div class="container py-4">
            <div class="section-header">
                <h1>My Printers</h1>
                <button class="btn btn-primary add-button open-printer-modal">Add Printer</button>
            </div>
            
            <div class="printer-table-container">
                <table class="printer-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>IP Address</th>
                            <th>Queue</th>
                            <th>Rate (B&W)</th>
                            <th>Rate (Color)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="printer : ${printers}">
                            <td th:text="${printer.name}">HP LaserJet Pro</td>
                            <td th:text="${printer.location}">Library 2nd Floor</td>
                            <td>
                                <span th:class="'status-indicator status-' + ${printer.status?.toString()?.toLowerCase()}" 
                                      th:text="${printer.status}">ONLINE</span>
                            </td>
                            <td th:text="${printer.ipAddress}">192.168.1.100</td>
                            <td th:text="${printer.queueLength}">3</td>
                            <td th:text="'৳' + ${printer.blackAndWhiteRate}">৳2.00</td>
                            <td th:text="'৳' + ${printer.colorRate}">৳5.00</td>
                            <td class="actions">
                                <button class="btn-icon edit" th:data-id="${printer.id}" 
                                        onclick="checkStatus(this.getAttribute('data-id'), this)">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="12" y1="16" x2="12" y2="12"></line>
                                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                    </svg>
                                </button>
                                <button class="btn-icon edit" th:data-id="${printer.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button class="btn-icon delete" th:data-id="${printer.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M3 6h18"></path>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                        <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                        <tr th:if="${printers == null || printers.isEmpty()}">
                            <td colspan="8" style="text-align: center; padding: 2rem;">
                                No printers found. Click "Add Printer" to add your first printer.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Add Printer Modal -->
        <div class="modal fade" id="printerModal" tabindex="-1" aria-labelledby="printerModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="printerModalLabel">Add New Printer</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="printerForm" th:action="@{/printers/new}" method="post" class="needs-validation" novalidate>
                            <div class="mb-3">
                                <label for="name" class="form-label">Printer Name</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                                <div class="invalid-feedback">Please provide a printer name.</div>
                            </div>
                            <div class="mb-3">
                                <label for="location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="location" name="location" required>
                                <div class="invalid-feedback">Please provide a location.</div>
                            </div>
                            <div class="mb-3">
                                <label for="ipAddress" class="form-label">IP Address</label>
                                <input type="text" class="form-control" id="ipAddress" name="ipAddress" 
                                       pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$" 
                                       required>
                                <div class="invalid-feedback">Please provide a valid IP address (e.g., 192.168.1.100).</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="blackAndWhiteRate" class="form-label">Black & White Rate (৳)</label>
                                    <input type="number" class="form-control" id="blackAndWhiteRate" name="blackAndWhiteRate" 
                                           min="0" step="0.01" required>
                                    <div class="invalid-feedback">Please provide a valid rate.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="colorRate" class="form-label">Color Rate (৳)</label>
                                    <input type="number" class="form-control" id="colorRate" name="colorRate" 
                                           min="0" step="0.01" required>
                                    <div class="invalid-feedback">Please provide a valid rate.</div>
                                </div>
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Add Printer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </th:block>
    
    <th:block th:fragment="custom-scripts">
        <script>
            // Function to check printer status
            function checkStatus(printerId, button) {
                // Find the printer row
                const row = button.closest('tr');
                const ipAddress = row.cells[3].textContent;
                const statusCell = row.cells[2].querySelector('.status-indicator');
                
                // Update status to checking
                statusCell.textContent = 'Checking...';
                statusCell.className = 'status-indicator';
                
                // In a real implementation, this would make an API call to check the status
                setTimeout(() => {
                    try {
                        fetch(`http://${ipAddress}:5000/status`, { 
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            },
                            // Set a timeout to avoid hanging
                            signal: AbortSignal.timeout(5000)
                        })
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            }
                            throw new Error('Failed to connect to printer');
                        })
                        .then(data => {
                            statusCell.textContent = 'ONLINE';
                            statusCell.className = 'status-indicator status-online';
                            
                            // Update the printer status in the database
                            fetch(`/api/printers/${printerId}/status`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ status: 'ONLINE' })
                            }).catch(error => console.error('Error updating printer status:', error));
                        })
                        .catch(error => {
                            statusCell.textContent = 'OFFLINE';
                            statusCell.className = 'status-indicator status-offline';
                            console.error('Error checking printer status:', error);
                            
                            // Update the printer status in the database
                            fetch(`/api/printers/${printerId}/status`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ status: 'OFFLINE' })
                            }).catch(error => console.error('Error updating printer status:', error));
                        });
                    } catch (error) {
                        statusCell.textContent = 'ERROR';
                        statusCell.className = 'status-indicator status-error';
                        console.error('Error:', error);
                    }
                }, 1000);
            }
            
            // Add event listeners
            document.addEventListener('DOMContentLoaded', function() {
                // Delete buttons
                const deleteButtons = document.querySelectorAll('.btn-icon.delete');
                deleteButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const printerId = this.getAttribute('data-id');
                        if (confirm('Are you sure you want to delete this printer? This action cannot be undone.')) {
                            fetch(`/api/printers/${printerId}`, {
                                method: 'DELETE'
                            })
                            .then(response => {
                                if (response.ok) {
                                    window.location.reload();
                                } else {
                                    alert('Failed to delete printer. Please try again.');
                                }
                            })
                            .catch(error => {
                                console.error('Error deleting printer:', error);
                                alert('Failed to delete printer. Please try again.');
                            });
                        }
                    });
                });
                
                // Edit buttons
                const editButtons = document.querySelectorAll('.btn-icon.edit:not(:first-child)');
                editButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const printerId = this.getAttribute('data-id');
                        window.location.href = `/printers/${printerId}/edit`;
                    });
                });
                
                // Form validation
                const printerForm = document.getElementById('printerForm');
                if (printerForm) {
                    printerForm.addEventListener('submit', function(event) {
                        if (!printerForm.checkValidity()) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        printerForm.classList.add('was-validated');
                    });
                }
                
                // Initialize modal
                const openModalButton = document.querySelector('.open-printer-modal');
                if (openModalButton) {
                    openModalButton.addEventListener('click', function() {
                        const printerModal = new bootstrap.Modal(document.getElementById('printerModal'));
                        printerModal.show();
                    });
                }
            });
        </script>
    </th:block>
</body>
</html> 